package server;

import java.io.*;
import java.net.*;
import java.text.SimpleDateFormat;
import java.util.*;

public class ClientHandler extends Thread { [cite: 28]
    private Socket socket;
    private int clientNumber;
    private Map<String, String> userDatabase;
    private String dbFile;

    public ClientHandler(Socket socket, int clientNumber, Map<String, String> db, String dbFile) {
        this.socket = socket;
        this.clientNumber = clientNumber;
        this.userDatabase = db;
        this.dbFile = dbFile;
    }

    @Override
    public void run() { [cite: 28]
        try (DataInputStream in = new DataInputStream(socket.getInputStream());
             DataOutputStream out = new DataOutputStream(socket.getOutputStream())) { [cite: 28]

            String username = in.readUTF();
            String password = in.readUTF();

            if (authenticateUser(username, password)) {
                out.writeUTF("AUTH_SUCCESS");
                
                String imageName = in.readUTF();
                long fileSize = in.readLong();
                
                String time = new SimpleDateFormat("yyyy-MM-dd@HH:mm:ss").format(new Date());
                System.out.format("[%s - %s:%d - %s] : Image %s re√ßue pour traitement.%n",
                        username, socket.getInetAddress().getHostAddress(), socket.getPort(), time, imageName);

                byte[] imageData = new byte[(int) fileSize];
                in.readFully(imageData);
                
                // Ici, vous appelez votre classe Sobel
                byte[] processedImage = Sobel.applyFilter(imageData);
                
                out.writeLong(processedImage.length);
                out.write(processedImage);
                out.flush();
            } else {
                out.writeUTF("AUTH_FAILED");
            }
        } catch (IOException e) {
            System.err.println("Error handling client#" + clientNumber + ":" + e); [cite: 28]
        } finally {
            try { socket.close(); } catch (IOException e) {} [cite: 28]
        }
    }

    private synchronized boolean authenticateUser(String username, String password) {
        if (userDatabase.containsKey(username)) {
            return userDatabase.get(username).equals(password);
        } else {
            userDatabase.put(username, password);
            saveUserDatabase();
            return true;
        }
    }

    private synchronized void saveUserDatabase() {
        try (BufferedWriter writer = new BufferedWriter(new FileWriter(dbFile))) {
            for (Map.Entry<String, String> entry : userDatabase.entrySet()) {
                writer.write(entry.getKey() + "," + entry.getValue());
                writer.newLine();
            }
        } catch (IOException e) { e.printStackTrace(); }
    }
}