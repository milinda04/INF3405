package server;

import java.io.*;
import java.net.*;
import java.util.*;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import javax.imageio.ImageIO;
import java.awt.image.BufferedImage;

public class Serveur {
    private static final String DB_FILE = "users.txt";
    private static Map<String, String> userDatabase = new HashMap<>();

    public static void main(String[] args) {
        Scanner scanner = new Scanner(System.in);
        loadDatabase();

        System.out.print("Entrez l'adresse IP du serveur: ");
        String ip = scanner.nextLine();
        System.out.print("Entrez le port d'écoute (5000-5050): ");
        int port = scanner.nextInt();

        if (!isValidIP(ip) || port < 5000 || port > 5050) {
            System.out.println("Erreur: Paramètres invalides.");
            return;
        }

        try (ServerSocket listener = new ServerSocket()) {
            listener.bind(new InetSocketAddress(InetAddress.getByName(ip), port));
            System.out.format("Le serveur tourne sur %s:%d%n", ip, port);

            int clientCount = 0;
            while (true) {
                Socket socket = listener.accept();
                new ClientHandler(socket, clientCount++).start();
            }
        } catch (IOException e) {
            System.err.println("Erreur serveur: " + e.getMessage());
        }
    }

    private static boolean isValidIP(String ip) {
        String regex = "^(\\d{1,3}\\.){3}\\d{1,3}$";
        if (!ip.matches(regex)) return false;
        for (String part : ip.split("\\.")) {
            int val = Integer.parseInt(part);
            if (val < 0 || val > 255) return false;
        }
        return true;
    }

    private static synchronized void loadDatabase() {
        File file = new File(DB_FILE);
        if (!file.exists()) return;
        try (BufferedReader reader = new BufferedReader(new FileReader(file))) {
            String line;
            while ((line = reader.readLine()) != null) {
                String[] parts = line.split(":");
                if (parts.length == 2) userDatabase.put(parts[0], parts[1]);
            }
        } catch (IOException e) { e.printStackTrace(); }
    }

    private static synchronized boolean validateOrCreateUser(String user, String pass) {
        if (userDatabase.containsKey(user)) {
            return userDatabase.get(user).equals(pass);
        } else {
            userDatabase.put(user, pass);
            saveDatabase();
            return true;
        }
    }

    private static synchronized void saveDatabase() {
        try (PrintWriter writer = new PrintWriter(new FileWriter(DB_FILE))) {
            userDatabase.forEach((u, p) -> writer.println(u + ":" + p));
        } catch (IOException e) { e.printStackTrace(); }
    }

    // --- Client Handler Thread ---
    private static class ClientHandler extends Thread {
        private Socket socket;
        private int id;

        public ClientHandler(Socket s, int id) { this.socket = s; this.id = id; }

        public void run() {
            try (DataInputStream in = new DataInputStream(socket.getInputStream());
                 DataOutputStream out = new DataOutputStream(socket.getOutputStream())) {

                String user = in.readUTF();
                String pass = in.readUTF();

                if (!validateOrCreateUser(user, pass)) {
                    out.writeUTF("AUTH_FAILED");
                    return;
                }
                out.writeUTF("AUTH_SUCCESS");

                // Réception de l'image
                String fileName = in.readUTF();
                byte[] imgData = new byte[in.readInt()];
                in.readFully(imgData);

                // Log console requis
                String time = LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd@HH:mm:ss"));
                System.out.format("[%s - %s:%d - %s] : Image %s reçue.%n", 
                                  user, socket.getInetAddress().getHostAddress(), socket.getPort(), time, fileName);

                // Traitement Sobel
                BufferedImage img = ImageIO.read(new ByteArrayInputStream(imgData));
                BufferedImage processed = Sobel.process(img);

                // Envoi de l'image traitée
                ByteArrayOutputStream baos = new ByteArrayOutputStream();
                ImageIO.write(processed, "jpg", baos);
                byte[] outData = baos.toByteArray();
                out.writeInt(outData.length);
                out.write(outData);

            } catch (Exception e) {
                System.out.println("Erreur client #" + id + ": " + e.getMessage());
            } finally {
                try { socket.close(); } catch (IOException e) {}
            }
        }
    }
}