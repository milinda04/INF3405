package server;

import java.io.*;
import java.net.*;
import java.text.SimpleDateFormat;
import java.util.*;
import javax.imageio.ImageIO;
import java.awt.image.BufferedImage;

public class ClientHandler extends Thread {
    private Socket socket;
    private int clientNumber;
    private Map<String, String> userDatabase;
    private String dbFile;

    public ClientHandler(Socket socket, int clientNumber, Map<String, String> db, String dbFile) {
        this.socket = socket;
        this.clientNumber = clientNumber;
        this.userDatabase = db;
        this.dbFile = dbFile;
    }

    @Override
    public void run() {
        try (DataInputStream in = new DataInputStream(socket.getInputStream());
             DataOutputStream out = new DataOutputStream(socket.getOutputStream())) {

            String username = in.readUTF();
            String password = in.readUTF();

            if (authenticateUser(username, password)) {
                out.writeUTF("AUTH_SUCCESS");
                
                String imageName = in.readUTF();
                int fileSize = in.readInt();
                
                // Log console requis
                String time = new SimpleDateFormat("yyyy-MM-dd@HH:mm:ss").format(new Date());
                System.out.format("[%s - %s:%d - %s] : Image %s reÃ§ue pour traitement.%n",
                        username, socket.getInetAddress().getHostAddress(), socket.getPort(), time, imageName);

                byte[] imageData = new byte[fileSize];
                in.readFully(imageData);
                
                // Conversion byte[] -> BufferedImage pour Sobel
                BufferedImage img = ImageIO.read(new ByteArrayInputStream(imageData));
                BufferedImage processedImg = Sobel.process(img);
                
                // Conversion BufferedImage -> byte[] pour envoi
                ByteArrayOutputStream baos = new ByteArrayOutputStream();
                ImageIO.write(processedImg, "jpg", baos);
                byte[] processedData = baos.toByteArray();
                
                out.writeInt(processedData.length);
                out.write(processedData);
                out.flush();
                
            } else {
                out.writeUTF("AUTH_FAILED");
            }
        } catch (IOException e) {
            System.err.println("Erreur client #" + clientNumber + ": " + e.getMessage());
        } finally {
            try { socket.close(); } catch (IOException e) {}
        }
    }

    private synchronized boolean authenticateUser(String username, String password) {
        if (userDatabase.containsKey(username)) {
            return userDatabase.get(username).equals(password);
        } else {
            userDatabase.put(username, password);
            saveUserDatabase();
            return true;
        }
    }

    private synchronized void saveUserDatabase() {
        try (BufferedWriter writer = new BufferedWriter(new FileWriter(dbFile))) {
            for (Map.Entry<String, String> entry : userDatabase.entrySet()) {
                writer.write(entry.getKey() + "," + entry.getValue());
                writer.newLine();
            }
        } catch (IOException e) { e.printStackTrace(); }
    }
}