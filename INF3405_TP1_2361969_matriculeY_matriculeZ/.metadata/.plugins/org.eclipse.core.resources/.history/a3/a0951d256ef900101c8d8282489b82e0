package client;

import java.io.*;
import java.net.*;
import java.util.Scanner;
import java.nio.file.Files;
import java.nio.file.Paths;

public class Client {
    public static void main(String[] args) {
        Scanner sc = new Scanner(System.in);

        System.out.print("IP Serveur: ");
        String ip = sc.nextLine();
        System.out.print("Port (5000-5050): ");
        int port = Integer.parseInt(sc.nextLine());

        if (!isValidIP(ip) || port < 5000 || port > 5050) {
            System.out.println("Format IP ou Port invalide.");
            return;
        }

        System.out.print("Username: ");
        String user = sc.nextLine();
        System.out.print("Password: ");
        String pass = sc.nextLine();

        try (Socket socket = new Socket(ip, port);
             DataOutputStream out = new DataOutputStream(socket.getOutputStream());
             DataInputStream in = new DataInputStream(socket.getInputStream())) {

            // Authentification
            out.writeUTF(user);
            out.writeUTF(pass);
            if (in.readUTF().equals("AUTH_FAILED")) {
                System.out.println("Erreur dans la saisie du mot de passe");
                return;
            }

            System.out.print("Nom de l'image à traiter: ");
            String inputName = sc.nextLine();
            File imgFile = new File(inputName);
            if (!imgFile.exists()) {
                System.out.println("Fichier introuvable.");
                return;
            }

            System.out.print("Nom à donner à l'image traitée: ");
            String outputName = sc.nextLine();

            // Envoi
            byte[] fileContent = Files.readAllBytes(imgFile.toPath());
            out.writeUTF(inputName);
            out.writeInt(fileContent.length);
            out.write(fileContent);
            System.out.println("Image envoyée au serveur.");

            // Réception
            int len = in.readInt();
            byte[] processedData = new byte[len];
            in.readFully(processedData);

            Files.write(Paths.get(outputName), processedData);
            System.out.println("Image traitée reçue et sauvegardée : " + Paths.get(outputName).toAbsolutePath());

        } catch (Exception e) {
            System.err.println("Erreur: " + e.getMessage());
        }
    }

    private static boolean isValidIP(String ip) {
        String regex = "^(\\d{1,3}\\.){3}\\d{1,3}$";
        return ip.matches(regex);
    }
}