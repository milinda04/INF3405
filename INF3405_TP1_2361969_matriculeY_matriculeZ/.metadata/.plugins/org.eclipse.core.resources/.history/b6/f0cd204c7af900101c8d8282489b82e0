package client;

import java.io.*;
import java.net.Socket;
import java.util.Scanner;

public class Client {
    private static Socket socket;
    
    public static void main(String[] args) {
        Scanner scanner = new Scanner(System.in);
        
        // Demander l'adresse IP du serveur
        String serverAddress = "";
        while (true) {
            System.out.print("Entrez l'adresse IP du serveur: ");
            serverAddress = scanner.nextLine().trim();
            if (isValidIP(serverAddress)) {
                break;
            } else {
                System.out.println("Erreur: Adresse IP invalide. Format attendu: xxx.xxx.xxx.xxx");
            }
        }
        
        // Demander le port du serveur
        int serverPort = 0;
        while (true) {
            System.out.print("Entrez le port du serveur (5000-5050): ");
            try {
                serverPort = Integer.parseInt(scanner.nextLine().trim());
                if (serverPort >= 5000 && serverPort <= 5050) {
                    break;
                } else {
                    System.out.println("Erreur: Le port doit être entre 5000 et 5050.");
                }
            } catch (NumberFormatException e) {
                System.out.println("Erreur: Veuillez entrer un nombre valide.");
            }
        }
        
        // Demander le nom d'utilisateur
        System.out.print("Entrez votre nom d'utilisateur: ");
        String username = scanner.nextLine().trim();
        
        // Demander le mot de passe
        System.out.print("Entrez votre mot de passe: ");
        String password = scanner.nextLine().trim();
        
        try {
            // Connexion au serveur
            System.out.println("\nConnexion au serveur...");
            socket = new Socket(serverAddress, serverPort);
            System.out.println("Connecté au serveur " + serverAddress + ":" + serverPort);
            
            DataInputStream in = new DataInputStream(socket.getInputStream());
            DataOutputStream out = new DataOutputStream(socket.getOutputStream());
            
            // Envoyer les informations d'authentification
            out.writeUTF(username);
            out.writeUTF(password);
            out.flush();
            
            // Recevoir la réponse d'authentification
            String authResponse = in.readUTF();
            
            if (authResponse.equals("AUTH_FAILED")) {
                System.out.println("Erreur dans la saisie du mot de passe");
                socket.close();
                return;
            }
            
            System.out.println("Authentification réussie!\n");
            
            // Demander le nom de l'image à envoyer
            String imageFileName = "";
            File imageFile = null;
            while (true) {
                System.out.print("Entrez le nom de l'image à traiter (doit être dans le répertoire courant): ");
                imageFileName = scanner.nextLine().trim();
                imageFile = new File(imageFileName);
                
                if (imageFile.exists() && imageFile.isFile()) {
                    break;
                } else {
                    System.out.println("Erreur: Le fichier '" + imageFileName + "' n'existe pas.");
                }
            }
            
            // Demander le nom de l'image traitée
            System.out.print("Entrez le nom pour l'image traitée: ");
            String outputFileName = scanner.nextLine().trim();
            
            // Envoyer le nom de l'image
            out.writeUTF(imageFileName);
            
            // Lire l'image
            byte[] imageData = readImageFile(imageFile);
            
            // Envoyer la taille de l'image
            out.writeLong(imageData.length);
            
            // Envoyer l'image
            out.write(imageData);
            out.flush();
            
            System.out.println("\n>>> Image envoyée au serveur pour traitement...");
            
            // Recevoir la taille de l'image traitée
            long processedSize = in.readLong();
            
            // Recevoir l'image traitée
            byte[] processedImage = new byte[(int) processedSize];
            in.readFully(processedImage);
            
            // Sauvegarder l'image traitée
            File outputFile = new File(outputFileName);
            try (FileOutputStream fos = new FileOutputStream(outputFile)) {
                fos.write(processedImage);
            }
            
            String absolutePath = outputFile.getAbsolutePath();
            System.out.println(">>> Image traitée reçue et sauvegardée!");
            System.out.println(">>> Emplacement: " + absolutePath);
            
            // Fermer la connexion
            socket.close();
            System.out.println("\nDéconnexion du serveur.");
            
        } catch (IOException e) {
            System.err.println("Erreur de connexion: " + e.getMessage());
            e.printStackTrace();
        } finally {
            scanner.close();
        }
    }
    
    // Valider le format de l'adresse IP
    private static boolean isValidIP(String ip) {
        if (ip == null || ip.isEmpty()) {
            return false;
        }
        
        String[] parts = ip.split("\\.");
        if (parts.length != 4) {
            return false;
        }
        
        for (String part : parts) {
            try {
                int num = Integer.parseInt(part);
                if (num < 0 || num > 255) {
                    return false;
                }
            } catch (NumberFormatException e) {
                return false;
            }
        }
        return true;
    }
    
    // Lire un fichier image
    private static byte[] readImageFile(File file) throws IOException {
        try (FileInputStream fis = new FileInputStream(file);
             ByteArrayOutputStream baos = new ByteArrayOutputStream()) {
            
            byte[] buffer = new byte[4096];
            int bytesRead;
            
            while ((bytesRead = fis.read(buffer)) != -1) {
                baos.write(buffer, 0, bytesRead);
            }
            
            return baos.toByteArray();
        }
    }
}